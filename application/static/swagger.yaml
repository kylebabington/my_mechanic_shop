swagger: "2.0"
info:
  title: "My Mechanic Shop API"
  description: "Flask API for customers, mechanics, service tickets, and inventory."
  version: "1.0.0"

host: "localhost:5000"
schemes:
  - "http"

consumes:
  - "application/json"
produces:
  - "application/json"

# ---- AUTH (Bearer Token) ----
securityDefinitions:
  bearerAuth:
    type: apiKey
    name: Authorization
    in: header
    description: "Use: Bearer <auth_token>"

paths:
  # -------------------- Customers --------------------
  /customers/:
    post:
      tags: [Customers]
      summary: "Create customer"
      description: "Register a new customer. Email must be unique."
      parameters:
        - in: body
          name: body
          required: true
          schema: { $ref: "#/definitions/CustomerCreatePayload" }
      responses:
        201:
          description: "Created"
          schema: { $ref: "#/definitions/CustomerResponse" }
          examples:
            application/json:
              id: 1
              name: "John Doe"
              email: "john.doe@example.com"
              phone: "1234567890"
        400:
          description: "Validation error or email already exists"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Bad Request"
              message: "Email already exists"

    get:
      tags: [Customers]
      summary: "List customers (paginated)"
      description: "Supports query params: limit (1-100), offset (>=0)."
      parameters:
        - name: limit
          in: query
          type: integer
          required: false
        - name: offset
          in: query
          type: integer
          required: false
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/CustomersListResponse" }
          examples:
            application/json:
              customers:
                - id: 1
                  name: "Jane Doe"
                  email: "jane.doe@example.com"
                  phone: "123-456-7890"
                - id: 2
                  name: "John Smith"
                  email: "john.smith@example.com"
                  phone: "098-765-4321"
              limit: 10
              offset: 0
              total: 2
        400:
          description: "Bad pagination values"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Bad Request"
              message: "Invalid limit or offset"

  /customers/login:
    post:
      tags: [Customers]
      summary: "Login (returns auth token)"
      description: "Returns a JWT token for authentication."
      parameters:
        - in: body
          name: body
          required: true
          schema: { $ref: "#/definitions/CustomerLoginPayload" }
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/CustomerLoginResponse" }
          examples:
            application/json:
              auth_token: "1234567890..."
              customer_id: 1
        401:
          description: "Invalid credentials"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Unauthorized"
              message: "Invalid email or password."

  /customers/my-tickets:
    get:
      tags: [Customers]
      summary: "My tickets (auth)"
      description: "Returns a list of tickets for the logged-in customer."
      security:
        - bearerAuth: []
      responses:
        200:
          description: "OK"
          schema:
            type: array
            items: { $ref: "#/definitions/TicketResponse" }
          examples:
            application/json:
              - id: 10
                VIN: "1HGCM82633A004352"
                service_date: "2025-02-18"
                service_desc: "Oil change"
                customer_id: 1
        401:
          description: "Missing/invalid token"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Unauthorized"
              message: "Missing/invalid token"

  /customers/me:
    put:
      tags: [Customers]
      summary: "Update logged-in customer (auth)"
      description: "Updates the logged-in customer's information."
      security:
        - bearerAuth: []
      parameters:
        - in: body
          name: body
          required: true
          schema: { $ref: "#/definitions/CustomerCreatePayload" }
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/CustomerResponse" }
          examples:
            application/json:
              id: 1
              name: "John Doe Updated"
              email: "john.doe.updated@example.com"
              phone: "2345678910"
        401:
          description: "Missing/invalid token"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Unauthorized"
              message: "Missing/invalid token"

    delete:
      tags: [Customers]
      summary: "Delete logged-in customer (auth)"
      description: "Deletes the logged-in customer."
      security:
        - bearerAuth: []
      responses:
        204:
          description: "No Content (customer deleted successfully)"
        401:
          description: "Missing/invalid token"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Unauthorized"
              message: "Missing/invalid token"

  /customers/{customer_id}:
    get:
      tags: [Customers]
      summary: "Get customer by id"
      description: "Returns a customer by their ID."
      parameters:
        - name: customer_id
          in: path
          required: true
          type: integer
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/CustomerResponse" }
          examples:
            application/json:
              id: 1
              name: "John Doe"
              email: "john.doe@example.com"
              phone: "1234567890"
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Customer not found"

  # -------------------- Mechanics --------------------
  /mechanics/:
    post:
      tags: [Mechanics]
      summary: "Create mechanic"
      description: "Creates a new mechanic."
      parameters:
        - in: body
          name: body
          required: true
          schema: { $ref: "#/definitions/MechanicPayload" }
      responses:
        201:
          description: "Created"
          schema: { $ref: "#/definitions/MechanicResponse" }
          examples:
            application/json:
              id: 1
              name: "John Doe"
              email: "john.doe@garage.com"
              phone: "1234567890"
              salary: 50000.00
        400:
          description: "Validation error or email exists"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Bad Request"
              message: "Validation error or email exists"

    get:
      tags: [Mechanics]
      summary: "List mechanics"
      description: "Returns a list of mechanics."
      responses:
        200:
          description: "OK"
          schema:
            type: array
            items: { $ref: "#/definitions/MechanicResponse" }
          examples:
            application/json:
              - id: 1
                name: "John Doe"
                email: "john.doe@garage.com"
                phone: "1234567890"
                salary: 50000.00
              - id: 2
                name: "Jane Smith"
                email: "jane.smith@garage.com"
                phone: "0987654321"
                salary: 60000.00

  /mechanics/most-tickets:
    get:
      tags: [Mechanics]
      summary: "Mechanics by most tickets"
      description: "Returns a list of mechanics by the number of tickets they have."
      responses:
        200:
          description: "OK"
          schema:
            type: array
            items: { $ref: "#/definitions/MechanicMostTicketsResponse" }
          examples:
            application/json:
              - id: 1
                name: "John Doe"
                email: "john.doe@garage.com"
                phone: "1234567890"
                salary: 50000.00
                tickets_count: 10
              - id: 2
                name: "Jane Smith"
                email: "jane.smith@garage.com"
                phone: "0987654321"
                salary: 60000.00
                tickets_count: 8

  /mechanics/{mechanic_id}:
    get:
      tags: [Mechanics]
      summary: "Get mechanic by id"
      description: "Returns a mechanic by their ID."
      parameters:
        - name: mechanic_id
          in: path
          required: true
          type: integer
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/MechanicResponse" }
          examples:
            application/json:
              id: 1
              name: "John Doe"
              email: "john.doe@garage.com"
              phone: "1234567890"
              salary: 50000.00
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Mechanic not found"

    put:
      tags: [Mechanics]
      summary: "Update mechanic"
      description: "Updates a mechanic's information."
      parameters:
        - name: mechanic_id
          in: path
          required: true
          type: integer
        - in: body
          name: body
          required: true
          schema: { $ref: "#/definitions/MechanicPayload" }
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/MechanicResponse" }
          examples:
            application/json:
              id: 1
              name: "John Doe Updated"
              email: "john.doe.updated@garage.com"
              phone: "1234567890"
              salary: 55000.00
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Mechanic not found"

    delete:
      tags: [Mechanics]
      summary: "Delete mechanic"
      description: "Deletes a mechanic."
      parameters:
        - name: mechanic_id
          in: path
          required: true
          type: integer
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/DeleteResponse" }
          examples:
            application/json:
              message: "Mechanic deleted successfully"
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Mechanic not found"

  # -------------------- Inventory --------------------
  /inventory/:
    post:
      tags: [Inventory]
      summary: "Create part"
      description: "Creates a new part."
      parameters:
        - in: body
          name: body
          required: true
          schema: { $ref: "#/definitions/InventoryPayload" }
      responses:
        201:
          description: "Created"
          schema: { $ref: "#/definitions/InventoryResponse" }
          examples:
            application/json:
              id: 1
              name: "Brake Pad"
              price: 100.00
        400:
          description: "Validation error or name exists"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Bad Request"
              message: "Validation error or name exists"

    get:
      tags: [Inventory]
      summary: "List parts"
      description: "Returns a list of parts."
      responses:
        200:
          description: "OK"
          schema:
            type: array
            items: { $ref: "#/definitions/InventoryResponse" }
          examples:
            application/json:
              - id: 1
                name: "Brake Pad"
                price: 100.00
              - id: 2
                name: "Oil Filter"
                price: 20.00

  /inventory/{part_id}:
    get:
      tags: [Inventory]
      summary: "Get part"
      description: "Returns a part by their ID."
      parameters:
        - name: part_id
          in: path
          required: true
          type: integer
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/InventoryResponse" }
          examples:
            application/json:
              id: 1
              name: "Brake Pad"
              price: 100.00
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Part not found"

    put:
      tags: [Inventory]
      summary: "Update part"
      description: "Updates a part's information."
      parameters:
        - name: part_id
          in: path
          required: true
          type: integer
        - in: body
          name: body
          required: true
          schema: { $ref: "#/definitions/InventoryPayload" }
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/InventoryResponse" }
          examples:
            application/json:
              id: 1
              name: "Brake Pad Updated"
              price: 150.00
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Part not found"

    delete:
      tags: [Inventory]
      summary: "Delete part"
      description: "Deletes a part."
      parameters:
        - name: part_id
          in: path
          required: true
          type: integer
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/DeleteResponse" }
          examples:
            application/json:
              message: "Part deleted successfully"
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Part not found"

  # -------------------- Service Tickets --------------------
  /service-tickets/:
    post:
      tags: [Tickets]
      summary: "Create ticket (auth)"
      description: "Requires Bearer token. Rate limited: 5 per minute."
      security:
        - bearerAuth: []
      parameters:
        - in: body
          name: body
          required: true
          schema: { $ref: "#/definitions/TicketCreatePayload" }
      responses:
        201:
          description: "Created"
          schema: { $ref: "#/definitions/TicketResponse" }
          examples:
            application/json:
              id: 10
              VIN: "1HGCM82633A004352"
              service_date: "2025-02-18"
              service_desc: "Oil change"
              customer_id: 1

        401:
          description: "Missing/invalid token"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Unauthorized"
              message: "Missing/invalid token"
        429:
          description: "Rate limit exceeded"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Too Many Requests"
              message: "Rate limit exceeded"

    get:
      tags: [Tickets]
      summary: "List tickets"
      description: "Cached for 60 seconds."
      responses:
        200:
          description: "OK"
          schema:
            type: array
            items: { $ref: "#/definitions/TicketResponse" }
          examples:
            application/json:
              - id: 10
                VIN: "1HGCM82633A004352"
                service_date: "2025-02-18"
                service_desc: "Oil change"
                customer_id: 1

  /service-tickets/{ticket_id}:
    get:
      tags: [Tickets]
      summary: "Get ticket (auth, owner only)"
      description: "Returns a ticket by their ID."
      security:
        - bearerAuth: []
      parameters:
        - name: ticket_id
          in: path
          required: true
          type: integer
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/TicketResponse" }
          examples:
            application/json:
              id: 10
              VIN: "1HGCM82633A004352"
              service_date: "2025-02-18"
              service_desc: "Oil change"
              customer_id: 1
        401:
          description: "Missing/invalid token"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Unauthorized"
              message: "Missing/invalid token"
        403:
          description: "Forbidden (not owner)"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Forbidden"
              message: "Forbidden (not owner)"
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Ticket not found"

    put:
      tags: [Tickets]
      summary: "Update ticket (auth, owner only)"
      description: "Updates a ticket's information."
      security:
        - bearerAuth: []
      parameters:
        - name: ticket_id
          in: path
          required: true
          type: integer
        - in: body
          name: body
          required: true
          schema: { $ref: "#/definitions/TicketUpdatePayload" }
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/TicketResponse" }
          examples:
            application/json:
              id: 10
              VIN: "1HGCM82633A004352"
              service_date: "2025-02-18"
              service_desc: "Oil change"
              customer_id: 1
        403:
          description: "Forbidden"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Forbidden"
              message: "Forbidden (not owner)"
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Ticket not found"

    delete:
      tags: [Tickets]
      summary: "Delete ticket (auth, owner only)"
      description: "Deletes a ticket."
      security:
        - bearerAuth: []
      parameters:
        - name: ticket_id
          in: path
          required: true
          type: integer
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/DeleteResponse" }
          examples:
            application/json:
              message: "Ticket deleted successfully"
        403:
          description: "Forbidden"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Forbidden"
              message: "Forbidden (not owner)"
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Ticket not found"

  /service-tickets/{ticket_id}/edit:
    put:
      tags: [Tickets]
      summary: "Bulk add/remove mechanics (auth, owner only)"
      description: "Bulk adds or removes mechanics from a ticket."
      security:
        - bearerAuth: []
      parameters:
        - name: ticket_id
          in: path
          required: true
          type: integer
        - in: body
          name: body
          required: true
          schema: { $ref: "#/definitions/EditTicketMechanicsPayload" }
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/TicketResponse" }
          examples:
            application/json:
              id: 10
              VIN: "1HGCM82633A004352"
              service_date: "2025-02-18"
              service_desc: "Oil change"
              customer_id: 1
        400:
          description: "Bad payload"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Bad Request"
              message: "Bad payload"
        403:
          description: "Forbidden"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Forbidden"
              message: "Forbidden (not owner)"
        404:
          description: "Not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Ticket not found"

  /service-tickets/{ticket_id}/assign-mechanic/{mechanic_id}:
    put:
      tags: [Tickets]
      summary: "Assign mechanic to ticket"
      description: "Assigns a mechanic to a ticket."
      parameters:
        - name: ticket_id
          in: path
          required: true
          type: integer
        - name: mechanic_id
          in: path
          required: true
          type: integer
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/TicketResponse" }
          examples:
            application/json:
              id: 10
              VIN: "1HGCM82633A004352"
              service_date: "2025-02-18"
              service_desc: "Oil change"
              customer_id: 1
        404:
          description: "Ticket or mechanic not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Ticket or mechanic not found"

  /service-tickets/{ticket_id}/remove-mechanic/{mechanic_id}:
    put:
      tags: [Tickets]
      summary: "Remove mechanic from ticket"
      description: "Removes a mechanic from a ticket."
      parameters:
        - name: ticket_id
          in: path
          required: true
          type: integer
        - name: mechanic_id
          in: path
          required: true
          type: integer
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/TicketResponse" }
          examples:
            application/json:
              id: 10
              VIN: "1HGCM82633A004352"
              service_date: "2025-02-18"
              service_desc: "Oil change"
              customer_id: 1
        400:
          description: "Mechanic not assigned"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Bad Request"
              message: "Mechanic not assigned"
        404:
          description: "Ticket or mechanic not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Ticket or mechanic not found"

  /service-tickets/{ticket_id}/add-part/{part_id}:
    put:
      tags: [Tickets]
      summary: "Add part to ticket (auth, owner only)"
      description: "Adds a part to a ticket."
      security:
        - bearerAuth: []
      parameters:
        - name: ticket_id
          in: path
          required: true
          type: integer
        - name: part_id
          in: path
          required: true
          type: integer
      responses:
        200:
          description: "OK"
          schema: { $ref: "#/definitions/TicketResponse" }
          examples:
            application/json:
              id: 10
              VIN: "1HGCM82633A004352"
              service_date: "2025-02-18"
              service_desc: "Oil change"
              customer_id: 1
        403:
          description: "Forbidden"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Forbidden"
              message: "Forbidden (not owner)"
        404:
          description: "Ticket or part not found"
          schema: { $ref: "#/definitions/ErrorMessage" }
          examples:
            application/json:
              error: "Not Found"
              message: "Ticket or part not found"


definitions:
  # ---- Common error shapes ----
  ErrorMessage:
    type: object
    properties:
      error:
        type: string
      message:
        type: string

  # ---- Customers ----
  CustomerCreatePayload:
    type: object
    required: [name, email, password]
    properties:
      name: { type: string }
      email: { type: string }
      phone: { type: string }
      password: { type: string }

  CustomerResponse:
    type: object
    properties:
      id: { type: integer }
      name: { type: string }
      email: { type: string }
      phone: { type: string }

  CustomerLoginPayload:
    type: object
    required: [email, password]
    properties:
      email: { type: string }
      password: { type: string }

  CustomerLoginResponse:
    type: object
    properties:
      status: { type: string }
      message: { type: string }
      auth_token: { type: string }

  CustomersListResponse:
    type: object
    properties:
      limit: { type: integer }
      offset: { type: integer }
      count: { type: integer }
      customers:
        type: array
        items:
          $ref: "#/definitions/CustomerResponse"

  DeleteResponse:
    type: object
    properties:
      message: { type: string }

  # ---- Mechanics ----
  MechanicPayload:
    type: object
    required: [name, email, salary]
    properties:
      name: { type: string }
      email: { type: string }
      phone: { type: string }
      salary: { type: number, format: float }

  MechanicResponse:
    type: object
    properties:
      id: { type: integer }
      name: { type: string }
      email: { type: string }
      phone: { type: string }
      salary: { type: number, format: float }

  MechanicMostTicketsResponse:
    type: object
    properties:
      id: { type: integer }
      name: { type: string }
      email: { type: string }
      phone: { type: string }
      salary: { type: number, format: float }
      tickets_count: { type: integer }

  # ---- Inventory ----
  InventoryPayload:
    type: object
    required: [name, price]
    properties:
      name: { type: string }
      price: { type: number, format: float }

  InventoryResponse:
    type: object
    properties:
      id: { type: integer }
      name: { type: string }
      price: { type: number, format: float }

  # ---- Tickets ----
  TicketCreatePayload:
    type: object
    required: [VIN, service_date, service_desc]
    properties:
      VIN: { type: string }
      service_date: { type: string }
      service_desc: { type: string }

  TicketUpdatePayload:
    type: object
    required: [VIN, service_date, service_desc]
    properties:
      VIN: { type: string }
      service_date: { type: string }
      service_desc: { type: string }

  TicketResponse:
  type: object
  properties:
    id:
      type: integer
      example: 10
    VIN:
      type: string
      example: "1HGCM82633A004352"
    service_date:
      type: string
      example: "2026-02-19"
    service_desc:
      type: string
      example: "Oil change"
    customer_id:
      type: integer
      example: 1
    mechanics:
      type: array
      items:
        type: object
        properties:
          id:
            type: integer
            example: 2
          name:
            type: string
            example: "Bob Smith"
          email:
            type: string
            example: "bob@garage.com"
          phone:
            type: string
            example: "555-222-3333"
          salary:
            type: number
            format: float
            example: 50000
    parts:
      type: array
      items:
        type: object
        properties:
          id:
            type: integer
            example: 5
          name:
            type: string
            example: "Brake Pads"
          price:
            type: number
            format: float
            example: 79.99


  EditTicketMechanicsPayload:
    type: object
    properties:
      add_ids:
        type: array
        items: { type: integer }
      remove_ids:
        type: array
        items: { type: integer }
